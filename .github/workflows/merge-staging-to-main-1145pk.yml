name: Merge staging -> main at 11:45 PM PKT (only if updated)

on:
  schedule:
    # 11:45 PM PKT = 18:45 UTC (Pakistan is UTC+5)
    - cron: "30 9 * * *"
  workflow_dispatch: {}

concurrency:
  group: staging-to-main-1145pk
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git identity
        run: |
          git config user.name "ShahabAhmed56"
          git config user.email "saksmsng56@gmail.com"

      - name: Fetch latest branches
        run: |
          git fetch origin main staging --prune

      - name: Check if staging has new commits
        id: check
        run: |
          # Count commits in staging that are not in main
          ahead_count=$(git rev-list --count origin/main..origin/staging)
          echo "ahead_count=$ahead_count" >> $GITHUB_OUTPUT
          echo "Staging is ahead of main by: $ahead_count commits"

      - name: Stop if nothing to merge
        if: steps.check.outputs.ahead_count == '0'
        run: |
          echo "No new commits in staging. Exiting."
          exit 0

      - name: Merge staging into main
        run: |
          git checkout -B main origin/main
          git merge origin/staging --no-ff -m "Auto-merge staging -> main (11:45 PM PKT)"

      - name: Push to main
        run: |
          git push origin main
